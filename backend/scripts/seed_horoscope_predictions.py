"""Seed default horoscope predictions. Run after migrations."""
import asyncio
import sys
import uuid
from pathlib import Path

sys.path.insert(0, str(Path(__file__).resolve().parent.parent))

from sqlalchemy import select, delete
from app.database import async_session
from app.models import HoroscopePrediction


# Каждое предсказание — 5–6 предложений в шуточном тоне про ИТ и аутентификацию
PREDICTIONS = [
    """Ближайшую неделю придётся нелегко: разработчики часто будут протестировать ТоНеЗнаюЧтоТакНеЗнаюКак.
Заказчик попросит «сделать как в ВК, только по-другому».
Релиз перенесут на пятницу в 17:55.
Зато 2FA наконец заработает у всех в команде.
А в понедельник на ретро скажут: «В целом норм, но давайте ещё раз обсудим пароли».""",
    """Придёт заказчик, знающий все процессы и умеющий их описать.
Требования не будут меняться три дня подряд.
В Jira появятся осмысленные комментарии.
Один тикет закроют без десяти правок по скринам.
И даже про OTP спросят заранее, а не после деплоя.""",
    """Успех в переговорах: стейкхолдеры наконец согласуют требования.
Ревью кода пройдёт с первого раза, без «а давайте ещё вот так».
Тесты не упадут на проде.
Документация и код будут жить в одном репозитории.
И кто-то вспомнит, зачем нужна двухфакторка, до того как её отключат.""",
    """OTP придёт вовремя, а пароли — только сложные.
Никто не напишет «ну поставь 123456 на тест».
Заказчик перестанет слать логины в общий чат.
Деплой в пятницу отменят без объяснений — и все вздохнут с облегчением.
А в понедельник тикет «сделать нормальную авторизацию» закроют без переоткрытия.""",
    """Деплой пройдёт с первого раза. Почти.
Один откат будет — но не из-за вас.
Заказчик не попросит «вернуть как было вчера» до конца дня.
Тесты на проде не начнут падать из-за кэша.
И в слаке напишут «спасибо» раньше, чем «всё сломалось».""",
    """Баг окажется не в вашем коде.
Ревьюер найдёт опечатку до мержа.
Заказчик одобрит макет без «а можно красную кнопку зелёной».
Пароли в конфиге не окажутся закоммиченными.
И ретро закончится фразой: «На этой неделе всё было ок».""",
    """Коллеги оценят ваш коммит без лишних правок.
В пул-реквесте не попросят «переименовать всё заново».
Один тикет закроют без десяти комментариев «а давайте ещё».
Документация по API не разойдётся с кодом.
И кто-то сам вспомнит про OTP, не дожидаясь напоминания.""",
    """Ретро закончится без обвинений в адрес процессов.
Спринт не объявят провальным из-за одного бага.
Заказчик не напишет «мы передумали» в последний день.
Тесты покроют тот сценарий, который как раз упадёт на проде.
И пароль от тестовой базы не окажется в открытом доступе.""",
    """Документация обновится раньше, чем код.
Никто не попросит «просто расскажи в чате, как это работает».
Требования перестанут меняться после ревью.
2FA включат по плану, а не в панике после инцидента.
И в вики наконец появится раздел «Куда смотреть, когда всё падает».""",
    """Тесты покроют то, что нужно.
Редкий баг воспроизведётся с первого раза.
Заказчик пришлёт логи с нужным уровнем, а не скрин экрана.
Пароли в логах не появятся даже случайно.
И в конце дня кто-то скажет: «Норм день» — и будет не сарказм.""",
]


async def seed(force: bool = False):
    async with async_session() as session:
        if force:
            await session.execute(delete(HoroscopePrediction))
            await session.flush()
        else:
            result = await session.execute(select(HoroscopePrediction).limit(1))
            if result.scalar_one_or_none() is not None:
                print("Horoscope predictions already exist, skipping seed.")
                print("Use --force to replace with current list.")
                return
        for i, text in enumerate(PREDICTIONS):
            session.add(
                HoroscopePrediction(
                    uuid=uuid.uuid4().hex,
                    text=text,
                    sort_order=i,
                    is_active=True,
                )
            )
        await session.commit()
    print("Horoscope predictions seeded.")


if __name__ == "__main__":
    force = "--force" in sys.argv or "-f" in sys.argv
    asyncio.run(seed(force=force))
